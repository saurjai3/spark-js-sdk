import PeerConnectionManager from '../peer-connection-manager';

import {_ANSWER_} from '../constants';

const RoapUtil = {};

RoapUtil.setRemoteDescription = (meeting, session) => {
  console.info('Call-RoapHandler: Transmite WAIT_TX_OK', meeting.correlationId);
  if (!(meeting && (meeting.mediaPeerConnection || meeting.screenPeerConnection))) {
    console.error('Call-RoapHandler: DANGER no media or screen peer connection', meeting.correlationId);
    return Promise.reject();
  }
  let promise;
  if (meeting.mediaPeerConnection && meeting.screenPeerConnection) {
    promise = Promise.all([
      PeerConnectionManager.setRemoteSessionDetails(
        meeting.mediaPeerConnection,
        _ANSWER_,
        session.ANSWER.sdps[0],
        meeting.clientIdentifiers
      ),
      PeerConnectionManager.setRemoteSessionDetails(
        meeting.screenPeerConnection,
        _ANSWER_,
        session.ANSWER.sdps[1],
        meeting.clientIdentifiers
      )
    ]);
  }
  else if (meeting.screenPeerConnection) {
    promise = PeerConnectionManager.setRemoteSessionDetails(
      meeting.screenPeerConnection,
      _ANSWER_,
      session.ANSWER.sdps[0],
      meeting.clientIdentifiers
    );
  }
  return promise
    .then(() => {
      console.info('Call-RoapHandler: setRemote Description successfull', meeting.correlationId);
      return Promise.resolve({
        seq: session.ANSWER.seq,
        locusId: meeting.locusId,
        locusSelfId: meeting.locus.self.id,
        mediaId: meeting.mediaId,
        correlationId: meeting.correlationId
      });
    })
    .catch((err) => {
      console.error('Call-RoapHandler: Error setting remote and sending Roap Message', err);
      return Promise.reject();
    });
};

export default RoapUtil;
